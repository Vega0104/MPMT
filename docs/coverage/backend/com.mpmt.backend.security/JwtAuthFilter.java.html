<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtAuthFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mpmt-backend</a> &gt; <a href="index.source.html" class="el_package">com.mpmt.backend.security</a> &gt; <span class="el_source">JwtAuthFilter.java</span></div><h1>JwtAuthFilter.java</h1><pre class="source lang-java linenums">package com.mpmt.backend.security;

import com.mpmt.backend.service.UserService;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import java.util.List;

import java.io.IOException;

@Component
public class JwtAuthFilter extends OncePerRequestFilter {

    private final JwtService jwtService;
    private final UserService userService;

    @Autowired
<span class="fc" id="L26">    public JwtAuthFilter(JwtService jwtService, UserService userService) {</span>
<span class="fc" id="L27">        this.jwtService = jwtService;</span>
<span class="fc" id="L28">        this.userService = userService;</span>
<span class="fc" id="L29">    }</span>

    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain
    ) throws ServletException, IOException {

        // 0) Laisser passer TOUT pr√©flight CORS
<span class="fc bfc" id="L39" title="All 2 branches covered.">        if (&quot;OPTIONS&quot;.equalsIgnoreCase(request.getMethod())) {</span>
<span class="fc" id="L40">            filterChain.doFilter(request, response);</span>
<span class="fc" id="L41">            return;</span>
        }

        // Skip JWT validation for public endpoints
<span class="fc" id="L45">        String path = request.getRequestURI();</span>
<span class="fc" id="L46">        System.out.println(&quot;=== JWT Filter - Path: &quot; + path);</span>

<span class="fc bfc" id="L48" title="All 2 branches covered.">        if (path.startsWith(&quot;/api/auth/&quot;)</span>
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">                || path.startsWith(&quot;/auth/&quot;)           // si jamais des routes /auth/ non /api existent</span>
<span class="pc bpc" id="L50" title="1 of 2 branches missed.">                || path.startsWith(&quot;/hello&quot;)</span>
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">                || path.startsWith(&quot;/api/hello&quot;)</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">                || path.startsWith(&quot;/actuator/&quot;)) {</span>
<span class="fc" id="L53">            System.out.println(&quot;=== Skipping JWT for public endpoint&quot;);</span>
<span class="fc" id="L54">            filterChain.doFilter(request, response);</span>
<span class="fc" id="L55">            return;</span>
        }

<span class="fc" id="L58">        final String authHeader = request.getHeader(&quot;Authorization&quot;);</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">        System.out.println(&quot;=== Authorization Header: &quot; + (authHeader != null ? &quot;Present&quot; : &quot;Missing&quot;));</span>

<span class="fc bfc" id="L61" title="All 4 branches covered.">        if (authHeader == null || !authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="fc" id="L62">            System.out.println(&quot;=== No valid Authorization header, continuing without auth&quot;);</span>
<span class="fc" id="L63">            filterChain.doFilter(request, response);</span>
<span class="fc" id="L64">            return;</span>
        }

        try {
<span class="fc" id="L68">            final String jwt = authHeader.substring(7);</span>
<span class="fc" id="L69">            System.out.println(&quot;=== JWT extracted, length: &quot; + jwt.length());</span>

<span class="fc" id="L71">            final String userEmail = jwtService.extractEmail(jwt);</span>
<span class="fc" id="L72">            System.out.println(&quot;=== Email extracted: &quot; + userEmail);</span>

<span class="pc bpc" id="L74" title="2 of 4 branches missed.">            if (userEmail != null &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null) {</span>
<span class="fc" id="L75">                var userOpt = userService.getUserByEmail(userEmail);</span>
<span class="fc" id="L76">                System.out.println(&quot;=== User found in DB: &quot; + userOpt.isPresent());</span>

<span class="pc bpc" id="L78" title="1 of 4 branches missed.">                if (userOpt.isPresent() &amp;&amp; jwtService.isTokenValid(jwt, userEmail)) {</span>
<span class="fc" id="L79">                    System.out.println(&quot;=== Token valid, authenticating user&quot;);</span>
<span class="fc" id="L80">                    var user = userOpt.get();</span>

                    // Map RoleType -&gt; GrantedAuthority &quot;ROLE_&lt;ROLE&gt;&quot;
<span class="fc" id="L83">                    var authorities = List.of(new SimpleGrantedAuthority(&quot;ROLE_&quot; + user.getRole().name()));</span>

<span class="fc" id="L85">                    var authToken = new UsernamePasswordAuthenticationToken(</span>
                            user,
                            null,
                            authorities
                    );

<span class="fc" id="L91">                    authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));</span>
<span class="fc" id="L92">                    SecurityContextHolder.getContext().setAuthentication(authToken);</span>
<span class="fc" id="L93">                    System.out.println(&quot;=== Authentication successful&quot;);</span>
<span class="fc" id="L94">                } else {</span>
<span class="fc" id="L95">                    System.out.println(&quot;=== Token validation failed&quot;);</span>
                }
            }
<span class="fc" id="L98">        } catch (Exception e) {</span>
<span class="fc" id="L99">            System.err.println(&quot;=== JWT Filter ERROR: &quot; + e.getMessage());</span>
<span class="fc" id="L100">            e.printStackTrace();</span>
<span class="fc" id="L101">        }</span>

<span class="fc" id="L103">        filterChain.doFilter(request, response);</span>
<span class="fc" id="L104">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>