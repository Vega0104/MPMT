<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProjectMemberService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mpmt-backend</a> &gt; <a href="index.source.html" class="el_package">com.mpmt.backend.service</a> &gt; <span class="el_source">ProjectMemberService.java</span></div><h1>ProjectMemberService.java</h1><pre class="source lang-java linenums">package com.mpmt.backend.service;

import com.mpmt.backend.entity.ProjectMember;
import com.mpmt.backend.entity.Project;
import com.mpmt.backend.entity.User;
import com.mpmt.backend.repository.ProjectMemberRepository;
import com.mpmt.backend.repository.ProjectRepository;
import com.mpmt.backend.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.util.stream.Collectors;
import com.mpmt.backend.entity.RoleType;

import java.util.List;
import java.util.Optional;

@Service
public class ProjectMemberService {

    private final ProjectMemberRepository projectMemberRepository;
    private final ProjectRepository projectRepository;
    private final UserRepository userRepository;

    @Autowired
    public ProjectMemberService(
            ProjectMemberRepository projectMemberRepository,
            ProjectRepository projectRepository,
            UserRepository userRepository
<span class="fc" id="L29">    ) {</span>
<span class="fc" id="L30">        this.projectMemberRepository = projectMemberRepository;</span>
<span class="fc" id="L31">        this.projectRepository = projectRepository;</span>
<span class="fc" id="L32">        this.userRepository = userRepository;</span>
<span class="fc" id="L33">    }</span>

    public List&lt;ProjectMember&gt; getAllMembers() {
<span class="fc" id="L36">        return projectMemberRepository.findAll();</span>
    }

    public Optional&lt;ProjectMember&gt; getById(Long id) {
<span class="fc" id="L40">        return projectMemberRepository.findById(id);</span>
    }

    public ProjectMember createProjectMember(ProjectMember member) {
        // Charger le Project et User depuis la DB
<span class="fc" id="L45">        Project project = projectRepository.findById(member.getProject().getId())</span>
<span class="pc" id="L46">                .orElseThrow(() -&gt; new RuntimeException(&quot;Project not found&quot;));</span>
<span class="fc" id="L47">        User user = userRepository.findById(member.getUser().getId())</span>
<span class="pc" id="L48">                .orElseThrow(() -&gt; new RuntimeException(&quot;User not found&quot;));</span>

<span class="fc" id="L50">        member.setProject(project);</span>
<span class="fc" id="L51">        member.setUser(user);</span>

<span class="fc" id="L53">        return projectMemberRepository.save(member);</span>
    }

    // NOUVELLE MÉTHODE pour compatibilité avec ProjectController
    public ProjectMember createMember(ProjectMember member) {
        // Si on utilise les IDs directement
<span class="nc bnc" id="L59" title="All 4 branches missed.">        if (member.getProjectId() != null &amp;&amp; member.getUserId() != null) {</span>
<span class="nc" id="L60">            Project project = projectRepository.findById(member.getProjectId())</span>
<span class="nc" id="L61">                    .orElseThrow(() -&gt; new RuntimeException(&quot;Project not found&quot;));</span>
<span class="nc" id="L62">            User user = userRepository.findById(member.getUserId())</span>
<span class="nc" id="L63">                    .orElseThrow(() -&gt; new RuntimeException(&quot;User not found&quot;));</span>

<span class="nc" id="L65">            member.setProject(project);</span>
<span class="nc" id="L66">            member.setUser(user);</span>
        }

<span class="nc" id="L69">        return projectMemberRepository.save(member);</span>
    }



    public List&lt;ProjectMember&gt; getByProject(Project project) {
<span class="nc" id="L75">        return projectMemberRepository.findByProject(project);</span>
    }

    public List&lt;ProjectMember&gt; getByUser(User user) {
<span class="nc" id="L79">        return projectMemberRepository.findByUser(user);</span>
    }

    public Optional&lt;ProjectMember&gt; getByUserAndProject(User user, Project project) {
<span class="nc" id="L83">        return projectMemberRepository.findByUserAndProject(user, project);</span>
    }

    public void deleteProjectMember(Long id) {
<span class="fc" id="L87">        projectMemberRepository.deleteById(id);</span>
<span class="fc" id="L88">    }</span>

    public List&lt;Project&gt; findProjectsByUserId(Long userId) {
<span class="fc" id="L91">        List&lt;ProjectMember&gt; memberships = projectMemberRepository.findByUser_Id(userId); // &lt;-- conserve findByUser_Id</span>
<span class="fc" id="L92">        return memberships.stream()</span>
<span class="fc" id="L93">                .map(ProjectMember::getProject)</span>
<span class="fc" id="L94">                .collect(Collectors.toList());</span>
    }

    public List&lt;ProjectMember&gt; getMembersByProjectId(Long projectId) {
<span class="nc" id="L98">        return projectMemberRepository.findByProject_Id(projectId);</span>
    }

    public List&lt;ProjectMember&gt; findByProjectId(Long projectId) {
<span class="nc" id="L102">        return projectMemberRepository.findByProject_Id(projectId);</span>
    }

    public List&lt;ProjectMember&gt; findMembersByProjectId(Long projectId) {
<span class="nc" id="L106">        return projectMemberRepository.findByProject_Id(projectId);</span>
    }

    public Optional&lt;ProjectMember&gt; updateRole(Long projectMemberId, String newRole) {
<span class="fc" id="L110">        Optional&lt;ProjectMember&gt; pmOpt = projectMemberRepository.findById(projectMemberId);</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        if (pmOpt.isPresent()) {</span>
<span class="fc" id="L112">            ProjectMember pm = pmOpt.get();</span>
<span class="fc" id="L113">            pm.setRole(RoleType.valueOf(newRole));</span>
<span class="fc" id="L114">            projectMemberRepository.save(pm);</span>
<span class="fc" id="L115">            return Optional.of(pm);</span>
        } else {
<span class="nc" id="L117">            return Optional.empty();</span>
        }
    }

    public Optional&lt;ProjectMember&gt; getByUserIdAndProjectId(Long userId, Long projectId) {
<span class="nc" id="L122">        return projectMemberRepository.findByUser_IdAndProject_Id(userId, projectId);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>